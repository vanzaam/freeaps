---
description: Email configuration for iAPS mail service
globs:
alwaysApply: true
---

# Email Configuration for Sentry

## SSH Tunnel Setup

The email service uses an SSH tunnel to route mail through ru4 (mongo-arbiter2.aw2.ru) server.

### SSH Tunnel Service
- **Service Name:** `iAPS`
- **Local Port:** 2525
- **Remote Server:** mongo-arbiter2.aw2.ru
- **Remote Port:** 25 (SMTP)
- **Bind Address:** 0.0.0.0:2525 (all interfaces)

### Tunnel Configuration
```bash
# Service file: /etc/systemd/system/---
ExecStart=/usr/bin/ssh -N -L 0.0.0.0:2525:localhost:25 mongo-arbiter2.aw2.ru
```

## SMTP Configuration for Sentry

### Required Settings
- **SMTP Host:** `localhost`
- **SMTP Port:** `2525`
- **From Email:** `admin@aw2.ru` (or any @aw2.ru email)
- **Authentication:** None required (tunnel handles authentication)

### Why admin@aw2.ru?
- Has DKIM signing configured in opendkim
- Listed in `/etc/opendkim/signing.table` on ru4
- Passes DMARC validation
- Delivers to Gmail/Yandex without spam issues

## Monitoring

### Health Check Script
- **Location:** `/usr/local/bin/check-mail-tunnel.sh`
- **Cron Schedule:** Every 5 minutes (`*/5 * * * *`)
- **Log File:** `/var/log/sentry-tunnel.log`

### Service Status
```bash
# Check tunnel status
systemctl status sentry-mail-tunnel

# Check if port is listening
netstat -tlnp | grep 2525

# View tunnel logs
journalctl -u sentry-mail-tunnel -f
```

## Troubleshooting

### Common Issues
1. **Connection refused:** Check UFW firewall rules for port 2525
2. **DKIM failures:** Ensure sender uses @aw2.ru domain
3. **Spam issues:** Use admin@aw2.ru as sender

### Test Email
```bash
echo "Test message" | mail -s "Test Subject" -a "From: admin@aw2.ru" recipient@example.com
```

## Security Notes
- SSH tunnel uses key-based authentication
- No SMTP credentials needed
- UFW allows localhost:2525 traffic only
